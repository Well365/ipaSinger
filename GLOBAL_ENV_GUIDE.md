# 全局环境变量设置功能说明

## 新功能概述

现在 MacSigner 支持将 FASTLANE_SESSION 环境变量设置为全局可用，这意味着你可以在任何新打开的终端窗口（包括 iTerm2、Terminal.app 等）中使用这个 session token。

## 功能特点

### 1. 双重认证模式选择
- **应用专属密码**（推荐）：使用Apple ID的应用专属密码
- **账号密码**：使用Apple ID账号密码 + 双重验证码

### 2. 全局环境变量设置选项
- **开启**：将 FASTLANE_SESSION 写入shell配置文件（.zshrc, .bash_profile）
- **关闭**：仅在当前应用进程中设置环境变量

## 使用步骤

1. 点击主界面的"Session 管理"按钮
2. 选择认证方式（应用专属密码或账号密码）
3. 输入 Apple ID 和对应的密码
4. **重要**：确保"设置为全局环境变量"选项已开启
5. 点击"开始认证"
6. 如果使用账号密码模式，输入双重验证码
7. 认证成功后，环境变量将自动设置

## 验证环境变量设置

### 方法1：在新终端窗口测试
```bash
# 打开新的终端窗口（iTerm2、Terminal.app等）
echo $FASTLANE_SESSION
```

### 方法2：使用测试脚本
```bash
# 在项目目录下运行
./test_global_env.sh
```

### 方法3：检查配置文件
```bash
# 查看zsh配置
grep FASTLANE_SESSION ~/.zshrc

# 查看bash配置
grep FASTLANE_SESSION ~/.bash_profile
```

## 工作原理

当"设置为全局环境变量"选项开启时，应用会：

1. 设置当前进程的环境变量 `setenv("FASTLANE_SESSION", token, 1)`
2. 检测当前用户的shell类型（zsh/bash）
3. 将 `export FASTLANE_SESSION='token'` 写入相应的配置文件：
   - **zsh**: ~/.zshrc, ~/.zprofile
   - **bash**: ~/.bash_profile, ~/.bashrc
   - **通用**: ~/.profile
4. 自动替换或添加配置行
5. 复制export命令到剪贴板

## 配置文件更新说明

应用会智能处理配置文件：
- 如果文件中已存在 FASTLANE_SESSION 配置，会自动替换
- 如果没有，会在文件末尾添加新配置
- 添加注释标识：`# FASTLANE_SESSION - Auto-generated by MacSigner`

## 安全提示

- Session Token 有30天有效期
- 建议定期更新 session token
- 如果不需要全局访问，可以关闭全局环境变量选项
- 应用会在session即将过期时发送提醒通知

## 故障排除

如果环境变量在新终端中不可用：

1. 确认"设置为全局环境变量"选项已开启
2. 重新启动终端应用程序
3. 检查shell配置文件是否正确更新
4. 尝试手动source配置文件：`source ~/.zshrc`

## 与外部工具集成

设置全局环境变量后，你可以在任何支持环境变量的工具中使用：
- iTerm2
- Terminal.app
- VS Code 终端
- fastlane 命令行
- 其他构建脚本